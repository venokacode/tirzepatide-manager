<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tirzepatide æ³¨å°„ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .pulse-soft {
            animation: pulse-soft 2s ease-in-out infinite;
        }
        .body-part {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .body-part:hover {
            opacity: 0.7;
        }
        .body-part.selected {
            fill: #10b981;
            stroke: #059669;
            stroke-width: 3;
        }
        .body-part.used {
            fill: #fbbf24;
            opacity: 0.6;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-green-50 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-6xl"></div>

    <script>
        // æ•°æ®ç®¡ç†
        const Storage = {
            save(key, data) {
                localStorage.setItem(key, JSON.stringify(data));
            },
            load(key) {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            },
            clear(key) {
                localStorage.removeItem(key);
            }
        };

        // åº”ç”¨çŠ¶æ€
        let appState = Storage.load('tirzepatide_data') || {
            initialized: false,
            currentDose: null,
            doseCount: 0, // å½“å‰å‰‚é‡å·²æ‰“æ¬¡æ•° (0-4)
            injectionDay: null, // æ¯å‘¨æ³¨å°„æ—¥ (0-6)
            lastInjection: null,
            nextInjection: null,
            injectionHistory: [],
            injectionSites: {
                abdomen: [],
                thigh: [],
                upperArm: []
            },
            contacts: [],
            notifications: {
                browser: true,
                email: false
            }
        };

        // ä¿å­˜çŠ¶æ€
        function saveState() {
            Storage.save('tirzepatide_data', appState);
            render();
        }

        // æ—¥æœŸå·¥å…·
        function formatDate(date) {
            if (!date) return '';
            const d = new Date(date);
            return d.toLocaleDateString('zh-CN', { year: 'numeric', month: '2-digit', day: '2-digit' });
        }

        function getWeekdayName(day) {
            const days = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            return days[day];
        }

        function calculateNextInjection(lastDate, weekday) {
            const last = new Date(lastDate);
            const next = new Date(last);
            next.setDate(next.getDate() + 7);
            return next.toISOString();
        }

        function getDaysSince(date) {
            if (!date) return 0;
            const now = new Date();
            const then = new Date(date);
            return Math.floor((now - then) / (1000 * 60 * 60 * 24));
        }

        // è¯·æ±‚é€šçŸ¥æƒé™
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // å‘é€æµè§ˆå™¨é€šçŸ¥
        function sendNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: 'ğŸ’‰',
                    badge: 'ğŸ’‰'
                });
            }
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦æé†’
        function checkReminders() {
            if (!appState.initialized || !appState.nextInjection) return;
            
            const now = new Date();
            const next = new Date(appState.nextInjection);
            const hoursUntil = (next - now) / (1000 * 60 * 60);
            
            // æå‰24å°æ—¶æé†’
            if (hoursUntil <= 24 && hoursUntil > 23) {
                sendNotification('æ³¨å°„æé†’', 'æ‚¨çš„ä¸‹æ¬¡ Tirzepatide æ³¨å°„å°†åœ¨æ˜å¤©è¿›è¡Œï¼');
            }
            
            // å½“å¤©æé†’
            if (hoursUntil <= 1 && hoursUntil > 0) {
                sendNotification('æ³¨å°„æé†’', 'è¯¥è¿›è¡Œ Tirzepatide æ³¨å°„äº†ï¼');
            }
        }

        // åˆå§‹åŒ–è®¾ç½®
        function InitSetup() {
            return `
                <div class="bg-white rounded-2xl shadow-xl p-8 max-w-2xl mx-auto">
                    <div class="text-center mb-8">
                        <div class="text-6xl mb-4">ğŸ’‰</div>
                        <h1 class="text-3xl font-bold text-gray-800 mb-2">Tirzepatide æ³¨å°„ç®¡ç†</h1>
                        <p class="text-gray-600">å¼€å§‹æ‚¨çš„æ³¨å°„ç®¡ç†ä¹‹æ—…</p>
                    </div>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-lg font-semibold text-gray-700 mb-4">é€‰æ‹©æ‚¨çš„æƒ…å†µï¼š</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <button onclick="startNewInjection()" 
                                    class="p-6 border-2 border-blue-300 rounded-xl hover:bg-blue-50 hover:border-blue-500 transition-all">
                                    <div class="text-4xl mb-2">ğŸ†•</div>
                                    <div class="font-semibold text-gray-800">æ–°å¼€å§‹æ³¨å°„</div>
                                    <div class="text-sm text-gray-600 mt-1">ç¬¬ä¸€æ¬¡ä½¿ç”¨ Tirzepatide</div>
                                </button>
                                
                                <button onclick="continueExisting()" 
                                    class="p-6 border-2 border-green-300 rounded-xl hover:bg-green-50 hover:border-green-500 transition-all">
                                    <div class="text-4xl mb-2">ğŸ”„</div>
                                    <div class="font-semibold text-gray-800">å·²åœ¨è¿›è¡Œä¸­</div>
                                    <div class="text-sm text-gray-600 mt-1">ç»§ç»­è®°å½•å·²æœ‰ç–—ç¨‹</div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // æ–°å¼€å§‹è®¾ç½®
        function NewInjectionSetup() {
            return `
                <div class="bg-white rounded-2xl shadow-xl p-8 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">æ–°å¼€å§‹æ³¨å°„è®¾ç½®</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">èµ·å§‹å‰‚é‡ (mg)</label>
                            <select id="initialDose" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="2.5">2.5 mg</option>
                                <option value="5">5 mg</option>
                                <option value="7.5">7.5 mg</option>
                                <option value="10">10 mg</option>
                                <option value="12.5">12.5 mg</option>
                                <option value="15">15 mg</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">é¦–æ¬¡æ³¨å°„æ—¥æœŸ</label>
                            <input type="date" id="firstDate" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                max="${new Date().toISOString().split('T')[0]}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">æ¯å‘¨æ³¨å°„æ—¥</label>
                            <select id="weekday" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="0">å‘¨æ—¥</option>
                                <option value="1">å‘¨ä¸€</option>
                                <option value="2">å‘¨äºŒ</option>
                                <option value="3">å‘¨ä¸‰</option>
                                <option value="4">å‘¨å››</option>
                                <option value="5">å‘¨äº”</option>
                                <option value="6">å‘¨å…­</option>
                            </select>
                        </div>
                        
                        <div class="flex gap-4">
                            <button onclick="cancelSetup()" 
                                class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all">
                                è¿”å›
                            </button>
                            <button onclick="confirmNewInjection()" 
                                class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all font-semibold">
                                å¼€å§‹ç®¡ç†
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ç»§ç»­å·²æœ‰ç–—ç¨‹è®¾ç½®
        function ContinueSetup() {
            return `
                <div class="bg-white rounded-2xl shadow-xl p-8 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">ç»§ç»­å·²æœ‰ç–—ç¨‹</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">å½“å‰å‰‚é‡ (mg)</label>
                            <select id="currentDose" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="2.5">2.5 mg</option>
                                <option value="5">5 mg</option>
                                <option value="7.5">7.5 mg</option>
                                <option value="10">10 mg</option>
                                <option value="12.5">12.5 mg</option>
                                <option value="15">15 mg</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">å½“å‰æ˜¯ç¬¬å‡ é’ˆ</label>
                            <select id="doseProgress" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="1">ç¬¬ 1 é’ˆï¼ˆå…±4é’ˆï¼‰</option>
                                <option value="2">ç¬¬ 2 é’ˆï¼ˆå…±4é’ˆï¼‰</option>
                                <option value="3">ç¬¬ 3 é’ˆï¼ˆå…±4é’ˆï¼‰</option>
                                <option value="4">ç¬¬ 4 é’ˆï¼ˆå…±4é’ˆï¼‰</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">ä¸Šæ¬¡æ³¨å°„æ—¥æœŸ</label>
                            <input type="date" id="lastDate" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                max="${new Date().toISOString().split('T')[0]}">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">æ¯å‘¨æ³¨å°„æ—¥</label>
                            <select id="weekday" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="0">å‘¨æ—¥</option>
                                <option value="1">å‘¨ä¸€</option>
                                <option value="2">å‘¨äºŒ</option>
                                <option value="3">å‘¨ä¸‰</option>
                                <option value="4">å‘¨å››</option>
                                <option value="5">å‘¨äº”</option>
                                <option value="6">å‘¨å…­</option>
                            </select>
                        </div>
                        
                        <div class="flex gap-4">
                            <button onclick="cancelSetup()" 
                                class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all">
                                è¿”å›
                            </button>
                            <button onclick="confirmContinue()" 
                                class="flex-1 px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-semibold">
                                ç»§ç»­ç®¡ç†
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ä¸»ç•Œé¢
        function MainDashboard() {
            const daysSince = getDaysSince(appState.lastInjection);
            const isOverdue = daysSince > 7;
            const isMissed = daysSince > 4 && daysSince <= 11;
            const shouldSkip = daysSince > 11;
            
            const doseProgress = appState.doseCount;
            const needsPurchase = doseProgress === 4;
            const needsDoseChange = doseProgress === 0 && appState.injectionHistory.length > 0;
            
            return `
                <div class="space-y-6">
                    <!-- é¡¶éƒ¨çŠ¶æ€å¡ -->
                    <div class="bg-gradient-to-r from-blue-500 to-green-500 rounded-2xl shadow-xl p-8 text-white">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h1 class="text-3xl font-bold mb-2">Tirzepatide æ³¨å°„ç®¡ç†</h1>
                                <p class="text-blue-100">å½“å‰å‰‚é‡ï¼š${appState.currentDose} mg - ç¬¬ ${doseProgress}/4 é’ˆ</p>
                            </div>
                            <div class="text-6xl">ğŸ’‰</div>
                        </div>
                        
                        ${isOverdue ? `
                            <div class="bg-red-500 bg-opacity-30 border-2 border-red-300 rounded-lg p-4 mb-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-2xl">âš ï¸</span>
                                    <span class="font-bold text-lg">æ³¨å°„è¶…æœŸ</span>
                                </div>
                                <p class="text-sm">è·ç¦»ä¸Šæ¬¡æ³¨å°„å·²ç» ${daysSince} å¤©</p>
                                ${shouldSkip ? `
                                    <p class="text-sm font-semibold mt-2">âš ï¸ å·²è¶…è¿‡11å¤©ï¼Œå»ºè®®è·³è¿‡æœ¬æ¬¡ï¼Œé‡æ–°å®‰æ’ä¸‹æ¬¡æ³¨å°„</p>
                                    <button onclick="skipAndReschedule()" 
                                        class="mt-3 px-4 py-2 bg-white text-red-600 rounded-lg hover:bg-red-50 transition-all font-semibold">
                                        è·³è¿‡å¹¶é‡æ–°å®‰æ’
                                    </button>
                                ` : isMissed ? `
                                    <p class="text-sm font-semibold mt-2">ğŸ’¡ åœ¨4-11å¤©å†…ï¼Œå¯ä»¥å°½å¿«è¡¥æ‰“</p>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        ${needsPurchase ? `
                            <div class="bg-yellow-500 bg-opacity-30 border-2 border-yellow-300 rounded-lg p-4 mb-4">
                                <div class="flex items-center gap-2">
                                    <span class="text-2xl">ğŸ›’</span>
                                    <span class="font-bold">è´­ä¹°æé†’ï¼šå·²å®Œæˆ4é’ˆï¼Œè¯·åŠæ—¶é‡‡è´­ä¸‹ä¸€ç“¶è¯ç‰©ï¼</span>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${needsDoseChange ? `
                            <div class="bg-purple-500 bg-opacity-30 border-2 border-purple-300 rounded-lg p-4 mb-4">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-2xl">ğŸ’Š</span>
                                    <span class="font-bold">å‰‚é‡ç¡®è®¤ï¼šå®Œæˆä¸Šä¸€è½®4é’ˆï¼Œæ˜¯å¦éœ€è¦æ›´æ¢å‰‚é‡ï¼Ÿ</span>
                                </div>
                                <div class="flex gap-2 mt-3">
                                    <button onclick="changeDose()" 
                                        class="px-4 py-2 bg-white text-purple-600 rounded-lg hover:bg-purple-50 transition-all font-semibold">
                                        æ›´æ¢å‰‚é‡
                                    </button>
                                    <button onclick="keepDose()" 
                                        class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-all">
                                        ä¿æŒå½“å‰
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white bg-opacity-20 rounded-lg p-4">
                                <div class="text-sm text-blue-100 mb-1">ä¸Šæ¬¡æ³¨å°„</div>
                                <div class="text-2xl font-bold">${formatDate(appState.lastInjection)}</div>
                                <div class="text-sm text-blue-100 mt-1">${daysSince} å¤©å‰</div>
                            </div>
                            <div class="bg-white bg-opacity-20 rounded-lg p-4">
                                <div class="text-sm text-blue-100 mb-1">ä¸‹æ¬¡æ³¨å°„</div>
                                <div class="text-2xl font-bold">${formatDate(appState.nextInjection)}</div>
                                <div class="text-sm text-blue-100 mt-1">${getWeekdayName(appState.injectionDay)}</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- å¿«æ·æ“ä½œ -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button onclick="showInjectionCheck()" 
                            class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all text-left">
                            <div class="text-4xl mb-2">ğŸ’‰</div>
                            <div class="font-bold text-gray-800 text-lg">å¼€å§‹æ³¨å°„</div>
                            <div class="text-sm text-gray-600 mt-1">é£é™©æ£€æŸ¥ + è®°å½•</div>
                        </button>
                        
                        <button onclick="showSiteRotation()" 
                            class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all text-left">
                            <div class="text-4xl mb-2">ğŸ¯</div>
                            <div class="font-bold text-gray-800 text-lg">éƒ¨ä½è½®æ¢</div>
                            <div class="text-sm text-gray-600 mt-1">æŸ¥çœ‹æ³¨å°„ä½ç½®</div>
                        </button>
                        
                        <button onclick="showHistory()" 
                            class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition-all text-left">
                            <div class="text-4xl mb-2">ğŸ“Š</div>
                            <div class="font-bold text-gray-800 text-lg">æ³¨å°„å†å²</div>
                            <div class="text-sm text-gray-600 mt-1">æŸ¥çœ‹æ‰€æœ‰è®°å½•</div>
                        </button>
                    </div>
                    
                    <!-- è®¾ç½®å’ŒæŒ‡å— -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="font-bold text-gray-800 text-lg mb-4">âš™ï¸ æé†’è®¾ç½®</h3>
                            <button onclick="showSettings()" 
                                class="w-full px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all">
                                ç®¡ç†æé†’å’Œè”ç³»äºº
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="font-bold text-gray-800 text-lg mb-4">ğŸ“– ä½¿ç”¨æŒ‡å—</h3>
                            <button onclick="showGuide()" 
                                class="w-full px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all">
                                æŸ¥çœ‹æ³¨å°„è¯´æ˜
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // æ³¨å°„å‰æ£€æŸ¥
        function InjectionCheck() {
            return `
                <div class="bg-white rounded-2xl shadow-xl p-8 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">æ³¨å°„å‰é£é™©æ£€æŸ¥</h2>
                    
                    <div class="space-y-4 mb-8">
                        <div class="border-l-4 border-blue-500 bg-blue-50 p-4 rounded-r-lg">
                            <label class="flex items-start gap-3 cursor-pointer">
                                <input type="checkbox" id="check1" class="mt-1 w-5 h-5">
                                <div>
                                    <div class="font-semibold text-gray-800">â„ï¸ å†·è—ç¯å¢ƒç¡®è®¤</div>
                                    <div class="text-sm text-gray-600">è¯ç‰©å·²åœ¨2-8Â°Cå†·è—ï¼Œæˆ–å®¤æ¸©ä¿å­˜ä¸è¶…è¿‡21å¤©</div>
                                </div>
                            </label>
                        </div>
                        
                        <div class="border-l-4 border-green-500 bg-green-50 p-4 rounded-r-lg">
                            <label class="flex items-start gap-3 cursor-pointer">
                                <input type="checkbox" id="check2" class="mt-1 w-5 h-5">
                                <div>
                                    <div class="font-semibold text-gray-800">ğŸ’§ è¯æ¶²æ£€æŸ¥</div>
                                    <div class="text-sm text-gray-600">æ¶²ä½“æ¸…æ¾ˆé€æ˜æˆ–å¾®é»„ï¼Œæ— é¢—ç²’ç‰©æˆ–æµ‘æµŠ</div>
                                </div>
                            </label>
                        </div>
                        
                        <div class="border-l-4 border-yellow-500 bg-yellow-50 p-4 rounded-r-lg">
                            <label class="flex items-start gap-3 cursor-pointer">
                                <input type="checkbox" id="check3" class="mt-1 w-5 h-5">
                                <div>
                                    <div class="font-semibold text-gray-800">ğŸ“… æœ‰æ•ˆæœŸç¡®è®¤</div>
                                    <div class="text-sm text-gray-600">æ£€æŸ¥åŒ…è£…ä¸Šçš„æœ‰æ•ˆæœŸï¼Œç¡®ä¿æœªè¿‡æœŸ</div>
                                </div>
                            </label>
                        </div>
                        
                        <div class="border-l-4 border-purple-500 bg-purple-50 p-4 rounded-r-lg">
                            <label class="flex items-start gap-3 cursor-pointer">
                                <input type="checkbox" id="check4" class="mt-1 w-5 h-5">
                                <div>
                                    <div class="font-semibold text-gray-800">ğŸ§¼ æ¸…æ´å‡†å¤‡</div>
                                    <div class="text-sm text-gray-600">å·²æ´—æ‰‹ï¼Œæ³¨å°„éƒ¨ä½å·²ç”¨é…’ç²¾æ¶ˆæ¯’å¹¶æ™¾å¹²</div>
                                </div>
                            </label>
                        </div>
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="cancelInjection()" 
                            class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all">
                            å–æ¶ˆ
                        </button>
                        <button onclick="proceedToRecord()" id="proceedBtn"
                            class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg transition-all font-semibold opacity-50 cursor-not-allowed"
                            disabled>
                            ç»§ç»­è®°å½•
                        </button>
                    </div>
                </div>
                
                <script>
                    const checks = ['check1', 'check2', 'check3', 'check4'];
                    checks.forEach(id => {
                        document.getElementById(id).addEventListener('change', function() {
                            const allChecked = checks.every(c => document.getElementById(c).checked);
                            const btn = document.getElementById('proceedBtn');
                            if (allChecked) {
                                btn.disabled = false;
                                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                                btn.classList.add('hover:bg-blue-600');
                            } else {
                                btn.disabled = true;
                                btn.classList.add('opacity-50', 'cursor-not-allowed');
                                btn.classList.remove('hover:bg-blue-600');
                            }
                        });
                    });
                </script>
            `;
        }

        // æ£€æŸ¥éƒ¨ä½æ˜¯å¦å¯ç”¨ï¼ˆ4å‘¨é—´éš”ï¼‰
        function isSiteAvailable(siteId) {
            const siteHistory = appState.injectionSites[siteId];
            if (siteHistory.length === 0) return true;
            
            const lastUsed = new Date(siteHistory[siteHistory.length - 1]);
            const now = new Date();
            const daysSince = Math.floor((now - lastUsed) / (1000 * 60 * 60 * 24));
            
            return daysSince >= 28; // 4å‘¨ = 28å¤©
        }

        // è®°å½•æ³¨å°„
        function RecordInjection() {
            const sites = [
                { id: 'abdomen', name: 'è…¹éƒ¨', icon: 'ğŸŸ¢', desc: 'è‚šè„å‘¨å›´2è‹±å¯¸å¤–' },
                { id: 'thigh', name: 'å¤§è…¿', icon: 'ğŸ”µ', desc: 'å¤§è…¿å‰ä¾§ä¸Šéƒ¨' },
                { id: 'upperArm', name: 'ä¸Šè‡‚', icon: 'ğŸŸ¡', desc: 'ä¸Šè‡‚å¤–ä¾§åéƒ¨' }
            ];
            
            return `
                <div class="bg-white rounded-2xl shadow-xl p-8 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">è®°å½•æœ¬æ¬¡æ³¨å°„</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">æ³¨å°„éƒ¨ä½</label>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                ${sites.map(site => {
                                    const available = isSiteAvailable(site.id);
                                    const siteHistory = appState.injectionSites[site.id];
                                    const lastUsed = siteHistory.length > 0 ? siteHistory[siteHistory.length - 1] : null;
                                    const daysSince = lastUsed ? getDaysSince(lastUsed) : null;
                                    
                                    return `
                                    <label class="cursor-pointer">
                                        <input type="radio" name="site" value="${site.id}" class="peer hidden">
                                        <div class="border-2 ${available ? 'border-gray-300 peer-checked:border-blue-500 peer-checked:bg-blue-50' : 'border-yellow-400 bg-yellow-50 peer-checked:border-yellow-600'} rounded-lg p-4 transition-all">
                                            <div class="text-3xl mb-2">${site.icon}</div>
                                            <div class="font-semibold text-gray-800">${site.name}</div>
                                            <div class="text-xs text-gray-600 mt-1">${site.desc}</div>
                                            ${!available ? `
                                                <div class="text-xs text-yellow-700 font-semibold mt-2 flex items-center gap-1">
                                                    âš ï¸ ${daysSince}å¤©å‰ä½¿ç”¨
                                                </div>
                                            ` : lastUsed ? `
                                                <div class="text-xs text-green-600 mt-2">
                                                    âœ“ å¯ç”¨ (${daysSince}å¤©å‰)
                                                </div>
                                            ` : `
                                                <div class="text-xs text-green-600 mt-2">
                                                    âœ“ ä»æœªä½¿ç”¨
                                                </div>
                                            `}
                                        </div>
                                    </label>
                                `}).join('')}
                            </div>
                            <div class="mt-3 text-sm text-gray-600 bg-blue-50 border border-blue-200 rounded-lg p-3">
                                ğŸ’¡ <strong>è½®æ¢æç¤ºï¼š</strong>å»ºè®®æ¯æ¬¡æ›´æ¢æ³¨å°„éƒ¨ä½ï¼ŒåŒä¸€éƒ¨ä½é—´éš”è‡³å°‘4å‘¨ï¼ˆ28å¤©ï¼‰
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">æ³¨å°„æ—¶é—´</label>
                            <input type="datetime-local" id="injectionTime" 
                                value="${new Date().toISOString().slice(0, 16)}"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">å‰¯ä½œç”¨è®°å½•ï¼ˆå¯é€‰ï¼‰</label>
                            <div class="space-y-2">
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" value="nausea" class="w-4 h-4">
                                    <span class="text-gray-700">æ¶å¿ƒ</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" value="vomiting" class="w-4 h-4">
                                    <span class="text-gray-700">å‘•å</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" value="diarrhea" class="w-4 h-4">
                                    <span class="text-gray-700">è…¹æ³»</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" value="abdominal_pain" class="w-4 h-4">
                                    <span class="text-gray-700">è…¹ç—›</span>
                                </label>
                                <label class="flex items-center gap-2">
                                    <input type="checkbox" value="site_reaction" class="w-4 h-4">
                                    <span class="text-gray-700">æ³¨å°„éƒ¨ä½ååº”</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
                            <textarea id="notes" rows="3" 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                placeholder="è®°å½•ä»»ä½•å…¶ä»–ä¿¡æ¯..."></textarea>
                        </div>
                        
                        <div class="flex gap-4">
                            <button onclick="cancelInjection()" 
                                class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all">
                                å–æ¶ˆ
                            </button>
                            <button onclick="saveInjection()" 
                                class="flex-1 px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-semibold">
                                ä¿å­˜è®°å½•
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // å…¨å±€å‡½æ•°
        window.startNewInjection = function() {
            document.getElementById('app').innerHTML = NewInjectionSetup();
        };

        window.continueExisting = function() {
            document.getElementById('app').innerHTML = ContinueSetup();
        };

        window.cancelSetup = function() {
            render();
        };

        window.confirmNewInjection = function() {
            const dose = document.getElementById('initialDose').value;
            const date = document.getElementById('firstDate').value;
            const weekday = parseInt(document.getElementById('weekday').value);
            
            if (!date) {
                alert('è¯·é€‰æ‹©é¦–æ¬¡æ³¨å°„æ—¥æœŸ');
                return;
            }
            
            appState.initialized = true;
            appState.currentDose = dose;
            appState.doseCount = 1;
            appState.injectionDay = weekday;
            appState.lastInjection = date;
            appState.nextInjection = calculateNextInjection(date, weekday);
            
            saveState();
            requestNotificationPermission();
        };

        window.confirmContinue = function() {
            const dose = document.getElementById('currentDose').value;
            const progress = parseInt(document.getElementById('doseProgress').value);
            const lastDate = document.getElementById('lastDate').value;
            const weekday = parseInt(document.getElementById('weekday').value);
            
            if (!lastDate) {
                alert('è¯·é€‰æ‹©ä¸Šæ¬¡æ³¨å°„æ—¥æœŸ');
                return;
            }
            
            appState.initialized = true;
            appState.currentDose = dose;
            appState.doseCount = progress;
            appState.injectionDay = weekday;
            appState.lastInjection = lastDate;
            appState.nextInjection = calculateNextInjection(lastDate, weekday);
            
            saveState();
            requestNotificationPermission();
        };

        window.showInjectionCheck = function() {
            document.getElementById('app').innerHTML = InjectionCheck();
        };

        window.cancelInjection = function() {
            render();
        };

        window.proceedToRecord = function() {
            document.getElementById('app').innerHTML = RecordInjection();
        };

        window.saveInjection = function() {
            const site = document.querySelector('input[name="site"]:checked');
            if (!site) {
                alert('è¯·é€‰æ‹©æ³¨å°„éƒ¨ä½');
                return;
            }
            
            const time = document.getElementById('injectionTime').value;
            const sideEffects = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            const notes = document.getElementById('notes').value;
            
            // è®°å½•æ³¨å°„
            const injection = {
                date: time,
                dose: appState.currentDose,
                site: site.value,
                sideEffects,
                notes,
                doseNumber: appState.doseCount
            };
            
            appState.injectionHistory.push(injection);
            appState.lastInjection = time;
            appState.nextInjection = calculateNextInjection(time, appState.injectionDay);
            appState.doseCount = appState.doseCount === 4 ? 0 : appState.doseCount + 1;
            
            // è®°å½•æ³¨å°„éƒ¨ä½ä½¿ç”¨æ—¶é—´
            appState.injectionSites[site.value].push(time);
            
            saveState();
            
            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
            alert('âœ… æ³¨å°„è®°å½•å·²ä¿å­˜ï¼');
        };

        window.skipAndReschedule = function() {
            const newDate = prompt('è¯·è¾“å…¥æ–°çš„æ³¨å°„æ—¥æœŸ (YYYY-MM-DD)ï¼š');
            if (newDate) {
                appState.lastInjection = newDate;
                appState.nextInjection = calculateNextInjection(newDate, appState.injectionDay);
                saveState();
            }
        };

        window.changeDose = function() {
            const newDose = prompt('è¯·è¾“å…¥æ–°å‰‚é‡ (2.5, 5, 7.5, 10, 12.5, 15)ï¼š');
            if (newDose && ['2.5', '5', '7.5', '10', '12.5', '15'].includes(newDose)) {
                appState.currentDose = newDose;
                appState.doseCount = 1;
                saveState();
            }
        };

        window.keepDose = function() {
            appState.doseCount = 1;
            saveState();
        };

        window.showSettings = function() {
            const html = `
                <div class="bg-white rounded-2xl shadow-xl p-8 max-w-3xl mx-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">âš™ï¸ è®¾ç½®</h2>
                        <button onclick="render()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                            è¿”å›
                        </button>
                    </div>
                    
                    <!-- é€šçŸ¥è®¾ç½® -->
                    <div class="mb-8">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ”” é€šçŸ¥è®¾ç½®</h3>
                        <div class="space-y-4">
                            <label class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                <div>
                                    <div class="font-semibold text-gray-800">æµè§ˆå™¨é€šçŸ¥</div>
                                    <div class="text-sm text-gray-600">åœ¨æµè§ˆå™¨ä¸­æ¥æ”¶æ³¨å°„æé†’</div>
                                </div>
                                <input type="checkbox" id="browserNotif" ${appState.notifications.browser ? 'checked' : ''} 
                                    onchange="toggleBrowserNotification()"
                                    class="w-5 h-5 text-blue-500">
                            </label>
                            
                            <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <div class="text-sm text-gray-700">
                                    <strong>æé†’æ—¶æœºï¼š</strong>
                                    <ul class="mt-2 space-y-1 ml-4">
                                        <li>â€¢ æ³¨å°„å‰24å°æ—¶</li>
                                        <li>â€¢ æ³¨å°„å½“å¤©ï¼ˆæå‰1å°æ—¶ï¼‰</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è”ç³»äººç®¡ç† -->
                    <div class="mb-8">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ‘¥ æé†’æŠ„é€è”ç³»äºº</h3>
                        
                        <div class="mb-4">
                            <div class="flex gap-2">
                                <input type="text" id="contactName" placeholder="å§“å" 
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <input type="email" id="contactEmail" placeholder="é‚®ç®±åœ°å€" 
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <button onclick="addContact()" 
                                    class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-semibold">
                                    æ·»åŠ 
                                </button>
                            </div>
                            <div class="text-xs text-gray-500 mt-1">
                                æ·»åŠ å®¶äººæˆ–æœ‹å‹çš„è”ç³»æ–¹å¼ï¼Œä»–ä»¬å°†æ”¶åˆ°æ‚¨çš„æ³¨å°„æé†’é€šçŸ¥
                            </div>
                        </div>
                        
                        <div class="space-y-2">
                            ${appState.contacts.length === 0 ? `
                                <div class="text-center py-8 text-gray-500 border-2 border-dashed border-gray-200 rounded-lg">
                                    <div class="text-4xl mb-2">ğŸ‘¤</div>
                                    <p>æš‚æ— è”ç³»äºº</p>
                                </div>
                            ` : appState.contacts.map((contact, index) => `
                                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
                                    <div>
                                        <div class="font-semibold text-gray-800">${contact.name}</div>
                                        <div class="text-sm text-gray-600">${contact.email}</div>
                                    </div>
                                    <button onclick="removeContact(${index})" 
                                        class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-all">
                                        åˆ é™¤
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <div class="text-sm text-gray-700">
                                <strong>ğŸ“§ é‚®ä»¶æé†’åŠŸèƒ½ï¼š</strong>å®é™…é‚®ä»¶å‘é€éœ€è¦é…ç½®é‚®ä»¶æœåŠ¡å™¨ã€‚å½“å‰æ·»åŠ çš„è”ç³»äººå°†ä¿å­˜åœ¨æ‚¨çš„è®¾å¤‡ä¸­ï¼Œä½œä¸ºæé†’åå•å‚è€ƒã€‚
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ•°æ®ç®¡ç† -->
                    <div>
                        <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ’¾ æ•°æ®ç®¡ç†</h3>
                        <div class="space-y-3">
                            <button onclick="exportData()" 
                                class="w-full px-4 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-all font-semibold">
                                ğŸ“¤ å¯¼å‡ºæ‰€æœ‰æ•°æ®
                            </button>
                            
                            <button onclick="confirmClearData()" 
                                class="w-full px-4 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-all font-semibold">
                                ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰æ•°æ®
                            </button>
                            
                            <div class="text-xs text-gray-500 text-center">
                                æ•°æ®ä¿å­˜åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('app').innerHTML = html;
        };
        
        window.toggleBrowserNotification = function() {
            const enabled = document.getElementById('browserNotif').checked;
            appState.notifications.browser = enabled;
            
            if (enabled) {
                requestNotificationPermission();
            }
            
            saveState();
        };
        
        window.addContact = function() {
            const name = document.getElementById('contactName').value.trim();
            const email = document.getElementById('contactEmail').value.trim();
            
            if (!name || !email) {
                alert('è¯·å¡«å†™å§“åå’Œé‚®ç®±');
                return;
            }
            
            if (!email.includes('@')) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€');
                return;
            }
            
            appState.contacts.push({ name, email });
            saveState();
            showSettings(); // åˆ·æ–°ç•Œé¢
        };
        
        window.removeContact = function(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè”ç³»äººå—ï¼Ÿ')) {
                appState.contacts.splice(index, 1);
                saveState();
                showSettings(); // åˆ·æ–°ç•Œé¢
            }
        };
        
        window.exportData = function() {
            const dataStr = JSON.stringify(appState, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `tirzepatide-data-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            alert('âœ… æ•°æ®å·²å¯¼å‡ºï¼');
        };
        
        window.confirmClearData = function() {
            if (confirm('âš ï¸ ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                if (confirm('å†æ¬¡ç¡®è®¤ï¼šè¿™å°†åˆ é™¤æ‰€æœ‰æ³¨å°„è®°å½•ã€è®¾ç½®å’Œè”ç³»äººä¿¡æ¯ã€‚')) {
                    Storage.clear('tirzepatide_data');
                    location.reload();
                }
            }
        };

        window.showGuide = function() {
            const html = `
                <div class="bg-white rounded-2xl shadow-xl p-8 max-w-4xl mx-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">ğŸ“– Tirzepatide æ³¨å°„ä½¿ç”¨æŒ‡å—</h2>
                        <button onclick="render()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                            è¿”å›
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- åŸºæœ¬ä¿¡æ¯ -->
                        <div class="border-l-4 border-blue-500 bg-blue-50 p-6 rounded-r-xl">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">ğŸ’Š åŸºæœ¬ä¿¡æ¯</h3>
                            <div class="space-y-2 text-gray-700">
                                <p><strong>å•†å“åï¼š</strong>Mounjaroï¼ˆç³–å°¿ç—…ï¼‰/ Zepboundï¼ˆå‡é‡ï¼‰</p>
                                <p><strong>é€šç”¨åï¼š</strong>Tirzepatideï¼ˆæ›¿å°”æ³Šè‚½ï¼‰</p>
                                <p><strong>ç»™è¯æ–¹å¼ï¼š</strong>çš®ä¸‹æ³¨å°„ï¼Œæ¯å‘¨ä¸€æ¬¡</p>
                                <p><strong>å¸¸è§„å‰‚é‡ï¼š</strong>2.5mg â†’ 5mg â†’ 7.5mg â†’ 10mg â†’ 12.5mg â†’ 15mg</p>
                            </div>
                        </div>
                        
                        <!-- å‚¨å­˜è¦æ±‚ -->
                        <div class="border-l-4 border-green-500 bg-green-50 p-6 rounded-r-xl">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">â„ï¸ å‚¨å­˜è¦æ±‚</h3>
                            <ul class="space-y-2 text-gray-700">
                                <li class="flex items-start gap-2">
                                    <span class="text-green-500 font-bold">âœ“</span>
                                    <span><strong>å†·è—ä¿å­˜ï¼š</strong>2-8Â°Cï¼ˆå†°ç®±å†·è—å®¤ï¼‰</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-green-500 font-bold">âœ“</span>
                                    <span><strong>å®¤æ¸©å­˜æ”¾ï¼š</strong>æœ€é«˜30Â°Cï¼Œæœ€å¤š21å¤©</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-red-500 font-bold">âœ—</span>
                                    <span><strong>ä¸å¯å†·å†»ï¼š</strong>å¦‚å·²å†·å†»è¯·ä¸¢å¼ƒ</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-green-500 font-bold">âœ“</span>
                                    <span><strong>é¿å…‰ä¿å­˜ï¼š</strong>ä¿æŒåœ¨åŸåŒ…è£…ç›’ä¸­</span>
                                </li>
                            </ul>
                        </div>
                        
                        <!-- æ³¨å°„æ­¥éª¤ -->
                        <div class="border-l-4 border-purple-500 bg-purple-50 p-6 rounded-r-xl">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">ğŸ’‰ æ³¨å°„æ­¥éª¤</h3>
                            <div class="space-y-4">
                                <div class="bg-white p-4 rounded-lg">
                                    <div class="font-bold text-purple-700 mb-2">æ­¥éª¤ 1ï¼šå‡†å¤‡</div>
                                    <ul class="text-sm text-gray-700 space-y-1 ml-4">
                                        <li>â€¢ æ´—æ‰‹å¹¶æ“¦å¹²</li>
                                        <li>â€¢ ä»å†°ç®±å–å‡ºè¯ç‰©ï¼Œæ£€æŸ¥æœ‰æ•ˆæœŸ</li>
                                        <li>â€¢ æ£€æŸ¥æ¶²ä½“ï¼šåº”æ¸…æ¾ˆé€æ˜æˆ–å¾®é»„ï¼Œæ— é¢—ç²’</li>
                                        <li>â€¢ å‡†å¤‡é…’ç²¾æ£‰ç‰‡ã€é”å™¨ç›’</li>
                                    </ul>
                                </div>
                                
                                <div class="bg-white p-4 rounded-lg">
                                    <div class="font-bold text-purple-700 mb-2">æ­¥éª¤ 2ï¼šé€‰æ‹©æ³¨å°„éƒ¨ä½</div>
                                    <ul class="text-sm text-gray-700 space-y-1 ml-4">
                                        <li>â€¢ <strong>è…¹éƒ¨ï¼š</strong>è‚šè„å‘¨å›´è‡³å°‘5cmï¼ˆ2è‹±å¯¸ï¼‰å¤–</li>
                                        <li>â€¢ <strong>å¤§è…¿ï¼š</strong>å¤§è…¿å‰ä¾§ä¸Šéƒ¨</li>
                                        <li>â€¢ <strong>ä¸Šè‡‚ï¼š</strong>ä¸Šè‡‚å¤–ä¾§åéƒ¨ï¼ˆéœ€ä»–äººååŠ©ï¼‰</li>
                                        <li>â€¢ æ¯æ¬¡è½®æ¢éƒ¨ä½ï¼ŒåŒä¸€éƒ¨ä½é—´éš”4å‘¨</li>
                                    </ul>
                                </div>
                                
                                <div class="bg-white p-4 rounded-lg">
                                    <div class="font-bold text-purple-700 mb-2">æ­¥éª¤ 3ï¼šæ¶ˆæ¯’</div>
                                    <ul class="text-sm text-gray-700 space-y-1 ml-4">
                                        <li>â€¢ ç”¨é…’ç²¾æ£‰ç‰‡æ“¦æ‹­æ³¨å°„éƒ¨ä½</li>
                                        <li>â€¢ å¾…é…’ç²¾å®Œå…¨æŒ¥å‘ï¼ˆçº¦10ç§’ï¼‰</li>
                                        <li>â€¢ ä¸è¦å†æ¬¡è§¦æ‘¸æ¶ˆæ¯’åŒºåŸŸ</li>
                                    </ul>
                                </div>
                                
                                <div class="bg-white p-4 rounded-lg">
                                    <div class="font-bold text-purple-700 mb-2">æ­¥éª¤ 4ï¼šæ³¨å°„</div>
                                    <ul class="text-sm text-gray-700 space-y-1 ml-4">
                                        <li>â€¢ è½»è½»æèµ·çš®è‚¤å½¢æˆè¤¶çš±</li>
                                        <li>â€¢ å°†é’ˆå¤´ä»¥90åº¦è§’å¿«é€Ÿæ’å…¥</li>
                                        <li>â€¢ æŒ‰ä¸‹æ³¨å°„æŒ‰é’®ï¼Œä¿æŒ10ç§’</li>
                                        <li>â€¢ å¬åˆ°å’”å“’å£°ä¸”è®¡æ•°å™¨æ˜¾ç¤º"0"</li>
                                        <li>â€¢ æ‹”å‡ºé’ˆå¤´ï¼Œæ¾å¼€çš®è‚¤</li>
                                    </ul>
                                </div>
                                
                                <div class="bg-white p-4 rounded-lg">
                                    <div class="font-bold text-purple-700 mb-2">æ­¥éª¤ 5ï¼šå–„å</div>
                                    <ul class="text-sm text-gray-700 space-y-1 ml-4">
                                        <li>â€¢ è½»å‹æ³¨å°„éƒ¨ä½ï¼ˆä¸è¦æ‰æ“ï¼‰</li>
                                        <li>â€¢ å°†ç”¨è¿‡çš„é’ˆå¤´/æ³¨å°„ç¬”æ”¾å…¥é”å™¨ç›’</li>
                                        <li>â€¢ ä¸è¦é‡å¤ä½¿ç”¨é’ˆå¤´æˆ–æ³¨å°„ç¬”</li>
                                        <li>â€¢ è®°å½•æ³¨å°„æ—¶é—´å’Œéƒ¨ä½</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å¸¸è§å‰¯ä½œç”¨ -->
                        <div class="border-l-4 border-orange-500 bg-orange-50 p-6 rounded-r-xl">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">âš ï¸ å¸¸è§å‰¯ä½œç”¨</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <div class="font-semibold text-gray-800 mb-2">è½»å¾®ååº”ï¼ˆå¸¸è§ï¼‰ï¼š</div>
                                    <ul class="text-sm text-gray-700 space-y-1">
                                        <li>â€¢ æ¶å¿ƒã€å‘•å</li>
                                        <li>â€¢ è…¹æ³»æˆ–ä¾¿ç§˜</li>
                                        <li>â€¢ é£Ÿæ¬²ä¸‹é™</li>
                                        <li>â€¢ è…¹ç—›ã€è…¹èƒ€</li>
                                        <li>â€¢ æ³¨å°„éƒ¨ä½è½»å¾®çº¢è‚¿</li>
                                    </ul>
                                </div>
                                
                                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                                    <div class="font-semibold text-red-700 mb-2">âš ï¸ éœ€ç«‹å³å°±åŒ»ï¼š</div>
                                    <ul class="text-sm text-red-700 space-y-1">
                                        <li>â€¢ ä¸¥é‡è…¹ç—›ï¼ˆå¯èƒ½æ˜¯èƒ°è…ºç‚ï¼‰</li>
                                        <li>â€¢ é¢ˆéƒ¨è‚¿å—ã€å£°éŸ³å˜¶å“‘</li>
                                        <li>â€¢ åå’½å›°éš¾ã€å‘¼å¸å›°éš¾</li>
                                        <li>â€¢ ä¸¥é‡è¿‡æ•ååº”ï¼ˆçš®ç–¹ã€è‚¿èƒ€ï¼‰</li>
                                        <li>â€¢ æŒç»­å‘•åå¯¼è‡´è„±æ°´</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ¼é’ˆå¤„ç† -->
                        <div class="border-l-4 border-yellow-500 bg-yellow-50 p-6 rounded-r-xl">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">â° æ¼é’ˆå¤„ç†</h3>
                            <div class="space-y-3 text-gray-700">
                                <div class="bg-white p-4 rounded-lg">
                                    <div class="font-semibold mb-1">âœ… 4å¤©å†…å‘ç°æ¼é’ˆï¼š</div>
                                    <p class="text-sm">å°½å¿«è¡¥æ‰“ï¼Œç„¶åæŒ‰æ–°çš„æ—¶é—´ç»§ç»­æ¯å‘¨æ³¨å°„</p>
                                </div>
                                
                                <div class="bg-white p-4 rounded-lg">
                                    <div class="font-semibold mb-1">âš ï¸ è¶…è¿‡4å¤©ï¼š</div>
                                    <p class="text-sm">è·³è¿‡æœ¬æ¬¡ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªé¢„å®šæ³¨å°„æ—¥ï¼Œé‡æ–°å¼€å§‹å‘¨æœŸ</p>
                                </div>
                                
                                <div class="bg-white p-4 rounded-lg">
                                    <div class="font-semibold mb-1">âŒ ä¸è¦ï¼š</div>
                                    <p class="text-sm">3å¤©å†…æ³¨å°„ä¸¤æ¬¡ï¼Œå¦åˆ™å¯èƒ½å¢åŠ å‰¯ä½œç”¨</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ³¨æ„äº‹é¡¹ -->
                        <div class="border-l-4 border-red-500 bg-red-50 p-6 rounded-r-xl">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">ğŸš« ç¦å¿Œå’Œæ³¨æ„</h3>
                            <ul class="space-y-2 text-gray-700">
                                <li class="flex items-start gap-2">
                                    <span class="text-red-500 font-bold">âœ—</span>
                                    <span>æœ‰ç”²çŠ¶è…ºé«“æ ·ç™Œä¸ªäººæˆ–å®¶æ—å²è€…ç¦ç”¨</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-red-500 font-bold">âœ—</span>
                                    <span>æœ‰å¤šå‘æ€§å†…åˆ†æ³Œè…ºç˜¤ç»¼åˆå¾2å‹ï¼ˆMEN 2ï¼‰è€…ç¦ç”¨</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-red-500 font-bold">âœ—</span>
                                    <span>å¯¹tirzepatideæˆ–ä»»ä½•æˆåˆ†è¿‡æ•è€…ç¦ç”¨</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-yellow-500 font-bold">âš </span>
                                    <span>å­•å¦‡å’Œå“ºä¹³æœŸå¦‡å¥³ä½¿ç”¨å‰è¯·å’¨è¯¢åŒ»ç”Ÿ</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-yellow-500 font-bold">âš </span>
                                    <span>å¦‚æœ‰èƒ°è…ºç‚ã€è‚¾ç—…ã€è§†ç½‘è†œç—…å˜å²ï¼Œè¯·å‘ŠçŸ¥åŒ»ç”Ÿ</span>
                                </li>
                            </ul>
                        </div>
                        
                        <!-- é”å™¨å¤„ç† -->
                        <div class="border-l-4 border-gray-500 bg-gray-50 p-6 rounded-r-xl">
                            <h3 class="text-lg font-bold text-gray-800 mb-3">ğŸ—‘ï¸ é”å™¨å®‰å…¨å¤„ç†</h3>
                            <ul class="space-y-2 text-gray-700">
                                <li class="flex items-start gap-2">
                                    <span class="text-blue-500 font-bold">âœ“</span>
                                    <span>ä½¿ç”¨FDAè®¤è¯çš„é”å™¨å¤„ç†ç›’</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-blue-500 font-bold">âœ“</span>
                                    <span>æˆ–ä½¿ç”¨åšå›ºçš„å¡‘æ–™å®¹å™¨ï¼ˆå¦‚æ´—æ¶¤å‰‚ç“¶ï¼‰</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-red-500 font-bold">âœ—</span>
                                    <span>ä¸è¦ç›´æ¥æ‰”è¿›åƒåœ¾æ¡¶æˆ–å›æ”¶ç®±</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-red-500 font-bold">âœ—</span>
                                    <span>ä¸è¦ä¸ä»–äººå…±ç”¨é’ˆå¤´æˆ–æ³¨å°„ç¬”</span>
                                </li>
                                <li class="flex items-start gap-2">
                                    <span class="text-blue-500 font-bold">âœ“</span>
                                    <span>æŒ‰å½“åœ°è§„å®šå¤„ç†åŒ»ç–—åºŸç‰©</span>
                                </li>
                            </ul>
                        </div>
                        
                        <!-- è”ç³»æ–¹å¼ -->
                        <div class="bg-gradient-to-r from-blue-500 to-green-500 text-white p-6 rounded-xl">
                            <h3 class="text-lg font-bold mb-3">ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ</h3>
                            <div class="space-y-2 text-sm">
                                <p>â€¢ å¦‚æœ‰ç”¨è¯ç–‘é—®ï¼Œè¯·å’¨è¯¢æ‚¨çš„åŒ»ç”Ÿæˆ–è¯å‰‚å¸ˆ</p>
                                <p>â€¢ ç¤¼æ¥å®¢æœçƒ­çº¿ï¼š1-800-Lilly-Rx (1-800-545-5979)</p>
                                <p>â€¢ å¦‚é‡ç´§æ€¥æƒ…å†µï¼Œè¯·ç«‹å³å°±åŒ»æˆ–æ‹¨æ‰“æ€¥æ•‘ç”µè¯</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('app').innerHTML = html;
        };

        window.showSiteRotation = function() {
            const sites = [
                { id: 'abdomen', name: 'è…¹éƒ¨', icon: 'ğŸŸ¢' },
                { id: 'thigh', name: 'å¤§è…¿', icon: 'ğŸ”µ' },
                { id: 'upperArm', name: 'ä¸Šè‡‚', icon: 'ğŸŸ¡' }
            ];
            
            const html = `
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">æ³¨å°„éƒ¨ä½è½®æ¢</h2>
                        <button onclick="render()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                            è¿”å›
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        ${sites.map(site => {
                            const available = isSiteAvailable(site.id);
                            const siteHistory = appState.injectionSites[site.id];
                            const lastUsed = siteHistory.length > 0 ? siteHistory[siteHistory.length - 1] : null;
                            const daysSince = lastUsed ? getDaysSince(lastUsed) : null;
                            const usageCount = siteHistory.length;
                            
                            return `
                                <div class="border-2 ${available ? 'border-green-300 bg-green-50' : 'border-yellow-300 bg-yellow-50'} rounded-xl p-6">
                                    <div class="text-6xl mb-3 text-center">${site.icon}</div>
                                    <div class="text-xl font-bold text-gray-800 text-center mb-2">${site.name}</div>
                                    
                                    <div class="space-y-2 text-sm">
                                        <div class="flex items-center justify-between">
                                            <span class="text-gray-600">çŠ¶æ€ï¼š</span>
                                            <span class="font-semibold ${available ? 'text-green-600' : 'text-yellow-600'}">
                                                ${available ? 'âœ“ å¯ç”¨' : 'âš ï¸ å»ºè®®ç­‰å¾…'}
                                            </span>
                                        </div>
                                        
                                        <div class="flex items-center justify-between">
                                            <span class="text-gray-600">ä½¿ç”¨æ¬¡æ•°ï¼š</span>
                                            <span class="font-semibold text-gray-800">${usageCount} æ¬¡</span>
                                        </div>
                                        
                                        ${lastUsed ? `
                                            <div class="flex items-center justify-between">
                                                <span class="text-gray-600">ä¸Šæ¬¡ä½¿ç”¨ï¼š</span>
                                                <span class="font-semibold text-gray-800">${daysSince} å¤©å‰</span>
                                            </div>
                                            
                                            ${!available ? `
                                                <div class="mt-3 p-2 bg-yellow-100 rounded text-xs text-yellow-800">
                                                    è¿˜éœ€ç­‰å¾… ${28 - daysSince} å¤©
                                                </div>
                                            ` : ''}
                                        ` : `
                                            <div class="mt-3 p-2 bg-green-100 rounded text-xs text-green-800">
                                                ä»æœªä½¿ç”¨è¿‡
                                            </div>
                                        `}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-6">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <span class="text-xl">ğŸ’¡</span>
                            <span>è½®æ¢å»ºè®®</span>
                        </h3>
                        <ul class="space-y-2 text-sm text-gray-700">
                            <li class="flex items-start gap-2">
                                <span class="text-blue-500 font-bold">â€¢</span>
                                <span>æ¯æ¬¡æ³¨å°„åº”æ›´æ¢ä¸åŒéƒ¨ä½</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-blue-500 font-bold">â€¢</span>
                                <span>åŒä¸€éƒ¨ä½é—´éš”è‡³å°‘ <strong>4å‘¨ï¼ˆ28å¤©ï¼‰</strong></span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-blue-500 font-bold">â€¢</span>
                                <span>é¿å…åœ¨æœ‰ç˜¢ç—•ã€ç˜€ä¼¤æˆ–çš®è‚¤ç ´æŸçš„åŒºåŸŸæ³¨å°„</span>
                            </li>
                            <li class="flex items-start gap-2">
                                <span class="text-blue-500 font-bold">â€¢</span>
                                <span>è…¹éƒ¨æ³¨å°„æ—¶è¿œç¦»è‚šè„è‡³å°‘2è‹±å¯¸ï¼ˆ5å˜ç±³ï¼‰</span>
                            </li>
                        </ul>
                    </div>
                </div>
            `;
            document.getElementById('app').innerHTML = html;
        };

        window.showHistory = function() {
            const history = appState.injectionHistory.slice().reverse();
            const html = `
                <div class="bg-white rounded-2xl shadow-xl p-8">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">æ³¨å°„å†å²</h2>
                        <button onclick="render()" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300">
                            è¿”å›
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        ${history.length === 0 ? `
                            <div class="text-center py-12 text-gray-500">
                                <div class="text-6xl mb-4">ğŸ“Š</div>
                                <p>æš‚æ— æ³¨å°„è®°å½•</p>
                            </div>
                        ` : history.map(inj => `
                            <div class="border border-gray-200 rounded-lg p-4">
                                <div class="flex items-start justify-between">
                                    <div>
                                        <div class="font-semibold text-gray-800">
                                            ${formatDate(inj.date)} - ${inj.dose} mg (ç¬¬${inj.doseNumber}/4é’ˆ)
                                        </div>
                                        <div class="text-sm text-gray-600 mt-1">
                                            æ³¨å°„éƒ¨ä½ï¼š${inj.site === 'abdomen' ? 'è…¹éƒ¨' : inj.site === 'thigh' ? 'å¤§è…¿' : 'ä¸Šè‡‚'}
                                        </div>
                                        ${inj.sideEffects && inj.sideEffects.length > 0 ? `
                                            <div class="text-sm text-orange-600 mt-1">
                                                å‰¯ä½œç”¨ï¼š${inj.sideEffects.join(', ')}
                                            </div>
                                        ` : ''}
                                        ${inj.notes ? `
                                            <div class="text-sm text-gray-600 mt-1">
                                                å¤‡æ³¨ï¼š${inj.notes}
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.getElementById('app').innerHTML = html;
        };

        // æ¸²æŸ“
        function render() {
            const app = document.getElementById('app');
            
            if (!appState.initialized) {
                app.innerHTML = InitSetup();
            } else {
                app.innerHTML = MainDashboard();
            }
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            render();
            
            // æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡æé†’
            setInterval(checkReminders, 60 * 60 * 1000);
            checkReminders();
        });
    </script>
</body>
</html>