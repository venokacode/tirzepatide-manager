<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tirzepatide æ³¨å°„ç®¡ç†åŠ©æ‰‹</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in {
            animation: fade-in 0.4s ease-out;
        }
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .timeline::before {
            content: "";
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #93c5fd, #34d399);
            left: 1rem;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-900">
    <div class="min-h-screen">
        <header class="bg-white shadow-sm">
            <div class="mx-auto flex max-w-6xl items-center justify-between px-6 py-4">
                <div>
                    <h1 class="text-2xl font-semibold text-slate-800">Tirzepatide æ³¨å°„ç®¡ç†åŠ©æ‰‹</h1>
                    <p class="text-sm text-slate-500">è®°å½•ã€æé†’ä¸æ³¨å°„ä½ç‚¹è½®æ¢ï¼Œä¸€ç«™å¼å®Œæˆ</p>
                </div>
                <button id="resetButton" class="rounded-lg border border-rose-200 px-3 py-2 text-sm text-rose-500 transition hover:border-rose-300 hover:bg-rose-50">
                    æ¸…ç©ºæ•°æ®
                </button>
            </div>
        </header>
        <main class="mx-auto max-w-6xl px-4 py-8" id="app"></main>
    </div>

    <script>
        const STORAGE_KEY = 'tirzepatide_manager_v2';
        const clone = value => (typeof structuredClone === 'function'
            ? structuredClone(value)
            : JSON.parse(JSON.stringify(value)));
        const DEFAULT_STATE = {
            initialized: false,
            currentDose: '',
            injectionDay: '',
            startDate: '',
            lastInjection: '',
            nextInjection: '',
            injectionHistory: [],
            injectionSites: {
                abdomen: [],
                thigh: [],
                upperArm: []
            },
            contacts: [],
            reminders: {
                browser: true,
                email: false
            },
            quality: {
                tests: [],
                reviews: []
            }
        };

        const App = {
            state: loadState(),
            save() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(this.state));
            },
            update(mutator) {
                mutator(this.state);
                this.save();
                render();
            },
            reset() {
                localStorage.removeItem(STORAGE_KEY);
                this.state = clone(DEFAULT_STATE);
                render();
            }
        };

        function loadState() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return clone(DEFAULT_STATE);
                const parsed = JSON.parse(raw);
                return normalizeState(parsed);
            } catch (error) {
                console.warn('è¯»å–æœ¬åœ°æ•°æ®å¤±è´¥ï¼Œå·²å›é€€ä¸ºé»˜è®¤å€¼', error);
                return clone(DEFAULT_STATE);
            }
        }

        function normalizeState(value) {
            const base = clone(DEFAULT_STATE);
            if (!value || typeof value !== 'object') {
                return base;
            }

            const directKeys = ['initialized', 'currentDose', 'injectionDay', 'startDate', 'lastInjection', 'nextInjection'];
            directKeys.forEach(key => {
                if (key in value) {
                    base[key] = value[key];
                }
            });

            base.reminders = Object.assign({}, DEFAULT_STATE.reminders, isPlainObject(value.reminders) ? value.reminders : {});
            base.contacts = Array.isArray(value.contacts)
                ? value.contacts.filter(isValidContact).map(contact => ({
                    name: contact.name,
                    phone: contact.phone,
                    note: contact.note || ''
                }))
                : [];
            base.injectionSites = Object.assign({}, DEFAULT_STATE.injectionSites, isPlainObject(value.injectionSites) ? value.injectionSites : {});
            base.injectionHistory = Array.isArray(value.injectionHistory)
                ? value.injectionHistory.map(normalizeHistoryEntry).filter(Boolean)
                : [];
            base.quality = normalizeQuality(value.quality);

            return base;
        }

        function normalizeHistoryEntry(entry) {
            if (!entry || typeof entry !== 'object') return null;
            if (!entry.date || !entry.site) return null;
            return {
                date: entry.date,
                site: entry.site,
                note: entry.note || '',
                recordedAt: entry.recordedAt || entry.date
            };
        }

        function normalizeQuality(value) {
            const base = clone(DEFAULT_STATE.quality);
            if (!isPlainObject(value)) {
                return base;
            }

            if (Array.isArray(value.tests)) {
                base.tests = value.tests.filter(isValidTest).map(item => ({
                    name: item.name,
                    date: item.date,
                    result: item.result,
                    note: item.note || ''
                }));
            }

            if (Array.isArray(value.reviews)) {
                base.reviews = value.reviews.filter(isValidReview).map(item => ({
                    reviewer: item.reviewer,
                    date: item.date,
                    status: item.status,
                    note: item.note || ''
                }));
            }

            return base;
        }

        function isPlainObject(value) {
            return value !== null && typeof value === 'object' && !Array.isArray(value);
        }

        function isValidContact(contact) {
            return contact && hasText(contact.name) && hasText(contact.phone);
        }

        function isValidTest(test) {
            return test && hasText(test.name) && hasText(test.date) && hasText(test.result);
        }

        function isValidReview(review) {
            return review && hasText(review.reviewer) && hasText(review.date) && hasText(review.status);
        }

        function hasText(value) {
            return typeof value === 'string' && value.trim() !== '';
        }

        function formatDate(value) {
            if (!value) return '';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '';
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function weekdayName(day) {
            const names = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];
            return names[Number(day)] ?? '';
        }

        function nextWeek(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (Number.isNaN(date.getTime())) return '';
            date.setDate(date.getDate() + 7);
            return date.toISOString();
        }

        function daysSince(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (Number.isNaN(date.getTime())) return '';
            const now = new Date();
            const diff = Math.floor((now - date) / (1000 * 60 * 60 * 24));
            return diff >= 0 ? diff : '';
        }

        function ensureNotificationPermission() {
            if (!('Notification' in window)) return;
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function sendNotification(title, body) {
            if (!('Notification' in window)) return;
            if (Notification.permission === 'granted') {
                new Notification(title, { body, icon: 'ğŸ’‰' });
            }
        }

        function render() {
            const container = document.getElementById('app');
            if (!container) return;

            container.innerHTML = App.state.initialized
                ? renderDashboard()
                : renderSetup();

            if (App.state.initialized) {
                bindDashboardEvents();
                evaluateReminders();
            } else {
                bindSetupEvents();
            }
        }

        function renderSetup() {
            return `
                <section class="fade-in rounded-2xl bg-white p-8 shadow-sm">
                    <h2 class="text-xl font-semibold text-slate-800">é¦–æ¬¡ä½¿ç”¨è®¾ç½®</h2>
                    <p class="mt-2 text-sm text-slate-500">å¡«å†™å½“å‰å¤„æ–¹å‰‚é‡ä¸æ³¨å°„æ—¶é—´ï¼Œæˆ‘ä»¬ä¼šå¸®ä½ è®°å½•ä¸‹ä¸€æ¬¡æ³¨å°„æ—¥æœŸã€‚</p>
                    <form id="setupForm" class="mt-6 grid gap-6 md:grid-cols-2">
                        <label class="flex flex-col gap-2 text-sm">
                            <span class="font-medium text-slate-700">å½“å‰å¤„æ–¹å‰‚é‡</span>
                            <select name="dose" required class="rounded-lg border border-slate-200 px-3 py-2 focus:border-blue-400 focus:outline-none">
                                <option value="">è¯·é€‰æ‹©å‰‚é‡</option>
                                <option value="2.5mg">2.5 mg</option>
                                <option value="5mg">5 mg</option>
                                <option value="7.5mg">7.5 mg</option>
                                <option value="10mg">10 mg</option>
                                <option value="12.5mg">12.5 mg</option>
                                <option value="15mg">15 mg</option>
                            </select>
                        </label>
                        <label class="flex flex-col gap-2 text-sm">
                            <span class="font-medium text-slate-700">æ¯å‘¨è®¡åˆ’æ³¨å°„æ—¥</span>
                            <select name="weekday" required class="rounded-lg border border-slate-200 px-3 py-2 focus:border-blue-400 focus:outline-none">
                                <option value="">è¯·é€‰æ‹©æ˜ŸæœŸ</option>
                                <option value="1">å‘¨ä¸€</option>
                                <option value="2">å‘¨äºŒ</option>
                                <option value="3">å‘¨ä¸‰</option>
                                <option value="4">å‘¨å››</option>
                                <option value="5">å‘¨äº”</option>
                                <option value="6">å‘¨å…­</option>
                                <option value="0">å‘¨æ—¥</option>
                            </select>
                        </label>
                        <label class="flex flex-col gap-2 text-sm">
                            <span class="font-medium text-slate-700">æœ€è¿‘ä¸€æ¬¡æ³¨å°„æ—¥æœŸ</span>
                            <input type="date" name="last" required class="rounded-lg border border-slate-200 px-3 py-2 focus:border-blue-400 focus:outline-none">
                        </label>
                        <label class="flex flex-col gap-2 text-sm">
                            <span class="font-medium text-slate-700">æ˜¯å¦å¼€å¯æµè§ˆå™¨æé†’</span>
                            <select name="notify" class="rounded-lg border border-slate-200 px-3 py-2 focus:border-blue-400 focus:outline-none">
                                <option value="yes">å¼€å¯</option>
                                <option value="no">å…³é—­</option>
                            </select>
                        </label>
                        <div class="md:col-span-2">
                            <button type="submit" class="w-full rounded-xl bg-blue-600 py-3 text-white transition hover:bg-blue-500">å®Œæˆå¹¶ä¿å­˜</button>
                        </div>
                    </form>
                </section>
            `;
        }

        function renderDashboard() {
            const { currentDose, injectionDay, lastInjection, nextInjection, injectionHistory, reminders, quality } = App.state;
            const nextDate = formatDate(nextInjection);
            const lastDate = formatDate(lastInjection);
            const dayDiff = daysSince(lastInjection);

            return `
                <div class="fade-in grid gap-6 lg:grid-cols-[2fr,1fr]">
                    <section class="rounded-2xl bg-white p-6 shadow-sm">
                        <h2 class="text-lg font-semibold text-slate-800">æ³¨å°„æ¦‚è§ˆ</h2>
                        <div class="mt-4 grid gap-4 md:grid-cols-3">
                            <article class="rounded-xl border border-slate-100 bg-slate-50 p-4">
                                <p class="text-xs font-medium uppercase tracking-wide text-slate-500">å½“å‰å‰‚é‡</p>
                                <p class="mt-2 text-2xl font-semibold text-slate-800">${currentDose || 'æœªè®¾ç½®'}</p>
                                <p class="text-xs text-slate-400">è®¡åˆ’æ³¨å°„æ—¥ï¼š${weekdayName(injectionDay) || '-'}</p>
                            </article>
                            <article class="rounded-xl border border-slate-100 bg-slate-50 p-4">
                                <p class="text-xs font-medium uppercase tracking-wide text-slate-500">ä¸‹ä¸€æ¬¡æ³¨å°„</p>
                                <p class="mt-2 text-2xl font-semibold text-slate-800">${nextDate || 'å¾…å®‰æ’'}</p>
                                <p class="text-xs text-slate-400">æˆ‘ä»¬ä¼šåœ¨å‰ä¸€å¤©æé†’ä½ </p>
                            </article>
                            <article class="rounded-xl border border-slate-100 bg-slate-50 p-4">
                                <p class="text-xs font-medium uppercase tracking-wide text-slate-500">è·ç¦»ä¸Šæ¬¡æ³¨å°„</p>
                                <p class="mt-2 text-2xl font-semibold text-slate-800">${dayDiff !== '' ? `${dayDiff} å¤©` : 'æœªè®°å½•'}</p>
                                <p class="text-xs text-slate-400">ä¸Šæ¬¡æ³¨å°„ï¼š${lastDate || '-'}</p>
                            </article>
                        </div>
                        <div class="mt-6 rounded-xl border border-dashed border-blue-200 bg-blue-50 p-4 text-sm text-blue-700">
                            æç¤ºï¼šä¿æŒæ³¨å°„ä½ç‚¹è½®æ¢ï¼Œé¿å…åœ¨åŒä¸€éƒ¨ä½è¿ç»­æ³¨å°„è¶…è¿‡ 4 æ¬¡ã€‚
                        </div>
                    </section>

                    <section class="rounded-2xl bg-white p-6 shadow-sm">
                        <h2 class="text-lg font-semibold text-slate-800">æé†’è®¾ç½®</h2>
                        <form id="reminderForm" class="mt-4 space-y-4 text-sm">
                            <label class="flex items-center justify-between gap-2">
                                <div>
                                    <p class="font-medium text-slate-700">æµè§ˆå™¨é€šçŸ¥</p>
                                    <p class="text-xs text-slate-400">åœ¨æ³¨å°„å‰ 24 å°æ—¶å’Œ 1 å°æ—¶æé†’</p>
                                </div>
                                <input type="checkbox" name="browser" ${reminders.browser ? 'checked' : ''} class="h-4 w-4">
                            </label>
                            <label class="flex items-center justify-between gap-2">
                                <div>
                                    <p class="font-medium text-slate-700">é‚®ä»¶é€šçŸ¥ï¼ˆæš‚å­˜ï¼‰</p>
                                    <p class="text-xs text-slate-400">æˆ‘ä»¬ä¼šåœ¨å°†æ¥æ”¯æŒå‘é€é‚®ä»¶æé†’</p>
                                </div>
                                <input type="checkbox" name="email" ${reminders.email ? 'checked' : ''} class="h-4 w-4">
                            </label>
                            <p class="text-xs text-slate-400">æ¸©é¦¨æç¤ºï¼šä¿å­˜è®¾ç½®åè¯·ä¿æŒæµè§ˆå™¨å…è®¸é€šçŸ¥æƒé™ã€‚</p>
                            <button type="submit" class="w-full rounded-lg bg-blue-600 py-2 text-sm font-medium text-white transition hover:bg-blue-500">ä¿å­˜æé†’è®¾ç½®</button>
                        </form>
                    </section>

                    <section class="rounded-2xl bg-white p-6 shadow-sm lg:col-span-2">
                        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                            <div>
                                <h2 class="text-lg font-semibold text-slate-800">è®°å½•æ³¨å°„</h2>
                                <p class="text-sm text-slate-500">é€‰æ‹©æ³¨å°„æ—¥æœŸå’Œéƒ¨ä½ï¼Œæˆ‘ä»¬ä¼šè‡ªåŠ¨å®‰æ’ä¸‹ä¸€æ¬¡æ—¥æœŸã€‚</p>
                            </div>
                            <button id="toggleRecord" class="rounded-lg border border-blue-200 px-4 py-2 text-sm text-blue-600 transition hover:border-blue-300 hover:bg-blue-50">å±•å¼€/æ”¶èµ·è¡¨å•</button>
                        </div>
                        <form id="recordForm" class="mt-4 grid gap-4 rounded-xl border border-slate-200 bg-slate-50 p-4">
                            <label class="flex flex-col gap-2 text-sm">
                                <span class="font-medium text-slate-700">æ³¨å°„æ—¥æœŸ</span>
                                <input type="date" name="date" value="${new Date().toISOString().slice(0,10)}" required class="rounded-lg border border-slate-200 px-3 py-2 focus:border-blue-400 focus:outline-none">
                            </label>
                            <label class="flex flex-col gap-2 text-sm">
                                <span class="font-medium text-slate-700">æ³¨å°„éƒ¨ä½</span>
                                <select name="site" required class="rounded-lg border border-slate-200 px-3 py-2 focus:border-blue-400 focus:outline-none">
                                    <option value="">è¯·é€‰æ‹©éƒ¨ä½</option>
                                    <option value="abdomen">è…¹éƒ¨</option>
                                    <option value="thigh">å¤§è…¿</option>
                                    <option value="upperArm">ä¸Šè‡‚</option>
                                </select>
                            </label>
                            <label class="flex flex-col gap-2 text-sm">
                                <span class="font-medium text-slate-700">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</span>
                                <textarea name="note" rows="2" class="rounded-lg border border-slate-200 px-3 py-2 focus:border-blue-400 focus:outline-none" placeholder="ä¾‹å¦‚ï¼šå·¦ä¾§è…¹éƒ¨ï¼Œè½»å¾®å‘çº¢"></textarea>
                            </label>
                            <button type="submit" class="rounded-lg bg-emerald-600 py-2 text-sm font-medium text-white transition hover:bg-emerald-500">ä¿å­˜è®°å½•</button>
                        </form>
                        <div class="mt-6 grid gap-6 md:grid-cols-2">
                            <div>
                                <h3 class="text-sm font-semibold text-slate-700">æ³¨å°„ä½ç‚¹é€Ÿè§ˆ</h3>
                                <div class="mt-3 flex flex-col gap-3 rounded-xl border border-slate-200 bg-white p-4">
                                    ${renderSiteSummary('abdomen', 'è…¹éƒ¨')}
                                    ${renderSiteSummary('thigh', 'å¤§è…¿')}
                                    ${renderSiteSummary('upperArm', 'ä¸Šè‡‚')}
                                </div>
                            </div>
                            <div>
                                <h3 class="text-sm font-semibold text-slate-700">æ³¨å°„ä½ç‚¹ç¤ºæ„</h3>
                                <div class="mt-3 flex justify-center rounded-xl border border-slate-200 bg-white p-4">
                                    ${renderSiteSvg()}
                                </div>
                            </div>
                        </div>
                    </section>

                    <section class="rounded-2xl bg-white p-6 shadow-sm lg:col-span-2">
                        <h2 class="text-lg font-semibold text-slate-800">æ³¨å°„å†å²</h2>
                        ${injectionHistory.length === 0 ? `
                            <p class="mt-4 text-sm text-slate-500">è¿˜æ²¡æœ‰æ³¨å°„è®°å½•ï¼Œå¿«æ¥è®°å½•ç¬¬ä¸€æ¬¡å§ï¼</p>
                        ` : `
                            <div class="relative mt-6 timeline">
                                <ul class="space-y-6 pl-12">
                                    ${injectionHistory.slice().reverse().map((item, index) => `
                                        <li class="relative rounded-xl border border-slate-100 bg-slate-50 p-4 shadow-sm">
                                            <div class="absolute left-[-3.35rem] top-5 h-3 w-3 rounded-full bg-blue-500"></div>
                                            <div class="flex flex-col gap-1 text-sm">
                                                <p class="text-slate-800">${formatDate(item.date)} Â· ${siteName(item.site)}</p>
                                                ${item.note ? `<p class="text-slate-500">${item.note}</p>` : ''}
                                                <p class="text-xs text-slate-400">è®°å½•æ—¶é—´ï¼š${formatDate(item.recordedAt)}</p>
                                            </div>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        `}
                    </section>

                    <section class="rounded-2xl bg-white p-6 shadow-sm lg:col-span-2">
                        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                            <div>
                                <h2 class="text-lg font-semibold text-slate-800">ç´§æ€¥è”ç³»äºº</h2>
                                <p class="text-sm text-slate-500">ä¿å­˜åŒ»ç”Ÿæˆ–è¯å¸ˆçš„è”ç³»æ–¹å¼ï¼Œå‡ºç°é—®é¢˜éšæ—¶è”ç³»ã€‚</p>
                            </div>
                            <button id="toggleContact" class="rounded-lg border border-blue-200 px-4 py-2 text-sm text-blue-600 transition hover:border-blue-300 hover:bg-blue-50">æ–°å¢è”ç³»äºº</button>
                        </div>
                        <form id="contactForm" class="mt-4 hidden grid gap-4 rounded-xl border border-slate-200 bg-slate-50 p-4">
                            <label class="flex flex-col gap-2 text-sm">
                                <span class="font-medium text-slate-700">å§“å</span>
                                <input type="text" name="name" required class="rounded-lg border border-slate-200 px-3 py-2 focus:border-blue-400 focus:outline-none">
                            </label>
                            <label class="flex flex-col gap-2 text-sm">
                                <span class="font-medium text-slate-700">è”ç³»æ–¹å¼</span>
                                <input type="text" name="phone" required class="rounded-lg border border-slate-200 px-3 py-2 focus:border-blue-400 focus:outline-none">
                            </label>
                            <label class="flex flex-col gap-2 text-sm">
                                <span class="font-medium text-slate-700">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</span>
                                <textarea name="note" rows="2" class="rounded-lg border border-slate-200 px-3 py-2 focus:border-blue-400 focus:outline-none"></textarea>
                            </label>
                            <button type="submit" class="rounded-lg bg-blue-600 py-2 text-sm font-medium text-white transition hover:bg-blue-500">ä¿å­˜è”ç³»äºº</button>
                        </form>
                        <ul class="mt-6 grid gap-4 md:grid-cols-2">
                            ${App.state.contacts.length === 0 ? '<li class="text-sm text-slate-500">æš‚æ— è”ç³»äººè®°å½•</li>' : App.state.contacts.map((contact, idx) => `
                                <li class="rounded-xl border border-slate-200 bg-slate-50 p-4">
                                    <div class="flex items-start justify-between gap-3">
                                        <div>
                                            <p class="text-base font-medium text-slate-800">${contact.name}</p>
                                            <p class="text-sm text-slate-500">${contact.phone}</p>
                                            ${contact.note ? `<p class="mt-2 text-xs text-slate-400">${contact.note}</p>` : ''}
                                        </div>
                                        <button data-index="${idx}" class="delete-contact text-xs text-rose-500">åˆ é™¤</button>
                                    </div>
                                </li>
                            `).join('')}
                        </ul>
                    </section>

                    <section class="rounded-2xl bg-white p-6 shadow-sm lg:col-span-2">
                        <h2 class="text-lg font-semibold text-slate-800">æ•°æ®å·¥å…·</h2>
                        <div class="mt-4 flex flex-col gap-3 text-sm md:flex-row">
                            <button id="exportButton" class="flex-1 rounded-lg border border-slate-200 px-4 py-2 text-slate-700 transition hover:border-slate-300 hover:bg-slate-50">å¯¼å‡ºå…¨éƒ¨æ•°æ® (JSON)</button>
                            <button id="copySummary" class="flex-1 rounded-lg border border-slate-200 px-4 py-2 text-slate-700 transition hover:border-slate-300 hover:bg-slate-50">å¤åˆ¶æœ€è¿‘ 4 æ¬¡æ³¨å°„æ‘˜è¦</button>
                        </div>
                        <p class="mt-3 text-xs text-slate-400">å¯¼å‡ºæ•°æ®å¯ç”¨äºå¤‡ä»½æˆ–ä¸åŒ»ç–—å›¢é˜Ÿå…±äº«ã€‚</p>
                    </section>

                    ${renderQualitySection(quality)}
                </div>
            `;
        }

        function renderQualitySection(quality) {
            const tests = quality?.tests ?? [];
            const reviews = quality?.reviews ?? [];
            return `
                <section class="rounded-2xl bg-white p-6 shadow-sm lg:col-span-2">
                    <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                        <div>
                            <h2 class="text-lg font-semibold text-slate-800">æµ‹è¯•ä¸ä»£ç å®¡æŸ¥</h2>
                            <p class="text-sm text-slate-500">è®°å½•æ¯æ¬¡æµ‹è¯•ç»“æœä¸ä»£ç å®¡æŸ¥çŠ¶æ€ï¼Œç¡®ä¿æ”¹åŠ¨é€šè¿‡è´¨é‡æŠŠå…³ã€‚</p>
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <button id="toggleTestForm" class="rounded-lg border border-emerald-200 px-4 py-2 text-sm text-emerald-600 transition hover:border-emerald-300 hover:bg-emerald-50">è®°å½•æµ‹è¯•</button>
                            <button id="toggleReviewForm" class="rounded-lg border border-indigo-200 px-4 py-2 text-sm text-indigo-600 transition hover:border-indigo-300 hover:bg-indigo-50">æ–°å¢ä»£ç å®¡æŸ¥</button>
                        </div>
                    </div>
                    <div class="mt-4 grid gap-4 md:grid-cols-2">
                        <form id="testForm" class="hidden grid gap-3 rounded-xl border border-emerald-100 bg-emerald-50 p-4 text-sm">
                            <label class="flex flex-col gap-1">
                                <span class="font-medium text-emerald-700">æµ‹è¯•åç§°</span>
                                <input type="text" name="name" required class="rounded-lg border border-emerald-200 px-3 py-2 focus:border-emerald-400 focus:outline-none" placeholder="ä¾‹å¦‚ï¼šæ ¸å¿ƒæµç¨‹å†’çƒŸæµ‹è¯•">
                            </label>
                            <label class="flex flex-col gap-1">
                                <span class="font-medium text-emerald-700">æ‰§è¡Œæ—¥æœŸ</span>
                                <input type="date" name="date" value="${new Date().toISOString().slice(0,10)}" required class="rounded-lg border border-emerald-200 px-3 py-2 focus:border-emerald-400 focus:outline-none">
                            </label>
                            <label class="flex flex-col gap-1">
                                <span class="font-medium text-emerald-700">ç»“æœ</span>
                                <select name="result" required class="rounded-lg border border-emerald-200 px-3 py-2 focus:border-emerald-400 focus:outline-none">
                                    <option value="pass">é€šè¿‡</option>
                                    <option value="fail">å¤±è´¥</option>
                                </select>
                            </label>
                            <label class="flex flex-col gap-1">
                                <span class="font-medium text-emerald-700">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</span>
                                <textarea name="note" rows="2" class="rounded-lg border border-emerald-200 px-3 py-2 focus:border-emerald-400 focus:outline-none" placeholder="è®°å½•é—®é¢˜æˆ–æ—¥å¿—ä½ç½®"></textarea>
                            </label>
                            <button type="submit" class="rounded-lg bg-emerald-600 py-2 text-sm font-medium text-white transition hover:bg-emerald-500">ä¿å­˜æµ‹è¯•ç»“æœ</button>
                        </form>
                        <form id="reviewForm" class="hidden grid gap-3 rounded-xl border border-indigo-100 bg-indigo-50 p-4 text-sm">
                            <label class="flex flex-col gap-1">
                                <span class="font-medium text-indigo-700">å®¡æŸ¥äºº</span>
                                <input type="text" name="reviewer" required class="rounded-lg border border-indigo-200 px-3 py-2 focus:border-indigo-400 focus:outline-none" placeholder="ä¾‹å¦‚ï¼šå¼ åŒ»ç”Ÿ">
                            </label>
                            <label class="flex flex-col gap-1">
                                <span class="font-medium text-indigo-700">å®¡æŸ¥æ—¥æœŸ</span>
                                <input type="date" name="date" value="${new Date().toISOString().slice(0,10)}" required class="rounded-lg border border-indigo-200 px-3 py-2 focus:border-indigo-400 focus:outline-none">
                            </label>
                            <label class="flex flex-col gap-1">
                                <span class="font-medium text-indigo-700">çŠ¶æ€</span>
                                <select name="status" required class="rounded-lg border border-indigo-200 px-3 py-2 focus:border-indigo-400 focus:outline-none">
                                    <option value="approved">é€šè¿‡</option>
                                    <option value="changes">éœ€ä¿®æ”¹</option>
                                    <option value="pending">ç­‰å¾…ä¸­</option>
                                </select>
                            </label>
                            <label class="flex flex-col gap-1">
                                <span class="font-medium text-indigo-700">å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</span>
                                <textarea name="note" rows="2" class="rounded-lg border border-indigo-200 px-3 py-2 focus:border-indigo-400 focus:outline-none" placeholder="åˆ—å‡ºå»ºè®®æˆ–å®¡æ‰¹è®°å½•"></textarea>
                            </label>
                            <button type="submit" class="rounded-lg bg-indigo-600 py-2 text-sm font-medium text-white transition hover:bg-indigo-500">ä¿å­˜å®¡æŸ¥è®°å½•</button>
                        </form>
                    </div>
                    <div class="mt-6 grid gap-6 md:grid-cols-2">
                        <div>
                            <h3 class="text-sm font-semibold text-emerald-700">æµ‹è¯•è®°å½•</h3>
                            <ul class="mt-3 space-y-3">
                                ${tests.length === 0 ? '<li class="text-sm text-slate-500">æš‚æ— æµ‹è¯•è®°å½•</li>' : tests.slice().reverse().map(renderTestItem).join('')}
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-sm font-semibold text-indigo-700">ä»£ç å®¡æŸ¥</h3>
                            <ul class="mt-3 space-y-3">
                                ${reviews.length === 0 ? '<li class="text-sm text-slate-500">æš‚æ— ä»£ç å®¡æŸ¥è®°å½•</li>' : reviews.slice().reverse().map(renderReviewItem).join('')}
                            </ul>
                        </div>
                    </div>
                </section>
            `;
        }

        function renderTestItem(item, index, array) {
            const actualIndex = array.length - 1 - index;
            const statusColor = item.result === 'pass' ? 'text-emerald-600' : 'text-rose-500';
            const statusLabel = item.result === 'pass' ? 'é€šè¿‡' : 'å¤±è´¥';
            return `
                <li class="rounded-xl border border-emerald-100 bg-white p-4 text-sm">
                    <div class="flex items-start justify-between gap-3">
                        <div>
                            <p class="text-base font-medium text-slate-800">${item.name}</p>
                            <p class="text-xs text-slate-400">æ‰§è¡Œæ—¥æœŸï¼š${formatDate(item.date)}</p>
                            <p class="mt-1 ${statusColor}">ç»“æœï¼š${statusLabel}</p>
                            ${item.note ? `<p class="mt-2 text-xs text-slate-500">${item.note}</p>` : ''}
                        </div>
                        <button data-index="${actualIndex}" class="delete-test text-xs text-rose-500">åˆ é™¤</button>
                    </div>
                </li>
            `;
        }

        function renderReviewItem(item, index, array) {
            const actualIndex = array.length - 1 - index;
            const statusMap = {
                approved: { label: 'é€šè¿‡', color: 'text-emerald-600' },
                changes: { label: 'éœ€ä¿®æ”¹', color: 'text-amber-500' },
                pending: { label: 'ç­‰å¾…ä¸­', color: 'text-slate-500' }
            };
            const status = statusMap[item.status] ?? statusMap.pending;
            return `
                <li class="rounded-xl border border-indigo-100 bg-white p-4 text-sm">
                    <div class="flex items-start justify-between gap-3">
                        <div>
                            <p class="text-base font-medium text-slate-800">${item.reviewer}</p>
                            <p class="text-xs text-slate-400">å®¡æŸ¥æ—¥æœŸï¼š${formatDate(item.date)}</p>
                            <p class="mt-1 ${status.color}">çŠ¶æ€ï¼š${status.label}</p>
                            ${item.note ? `<p class="mt-2 text-xs text-slate-500">${item.note}</p>` : ''}
                        </div>
                        <button data-index="${actualIndex}" class="delete-review text-xs text-rose-500">åˆ é™¤</button>
                    </div>
                </li>
            `;
        }

        function renderSiteSummary(siteKey, label) {
            const entries = App.state.injectionSites[siteKey] || [];
            if (entries.length === 0) {
                return `
                    <div class="flex items-center justify-between rounded-lg border border-dashed border-slate-200 px-3 py-2 text-sm text-slate-500">
                        <span>${label}</span>
                        <span>æš‚æ— è®°å½•</span>
                    </div>
                `;
            }
            const lastDate = entries[entries.length - 1];
            const count = entries.length;
            return `
                <div class="flex items-center justify-between rounded-lg border border-slate-200 bg-slate-100 px-3 py-2 text-sm">
                    <div>
                        <p class="font-medium text-slate-700">${label}</p>
                        <p class="text-xs text-slate-500">æœ€è¿‘ï¼š${formatDate(lastDate)}</p>
                    </div>
                    <span class="text-xs text-slate-400">ç´¯è®¡ ${count} æ¬¡</span>
                </div>
            `;
        }

        function renderSiteSvg() {
            const lastEntry = App.state.injectionHistory.length
                ? App.state.injectionHistory[App.state.injectionHistory.length - 1]
                : null;
            const highlight = site => {
                const entries = App.state.injectionSites[site] || [];
                if (entries.length === 0) return '#bfdbfe';
                return site === (lastEntry?.site)
                    ? '#34d399'
                    : '#93c5fd';
            };
            return `
                <svg viewBox="0 0 220 260" class="h-56 w-40">
                    <g stroke="#2563eb" stroke-width="1.5">
                        <path fill="${highlight('abdomen')}" d="M80 60 Q110 20 140 60 L140 150 Q110 180 80 150 Z"></path>
                        <path fill="${highlight('thigh')}" d="M75 150 Q110 190 100 240 L80 240 Q60 190 75 150 Z"></path>
                        <path fill="${highlight('upperArm')}" d="M145 80 Q180 100 170 160 Q150 180 140 150 Z"></path>
                    </g>
                </svg>
            `;
        }

        function siteName(key) {
            switch (key) {
                case 'abdomen': return 'è…¹éƒ¨';
                case 'thigh': return 'å¤§è…¿';
                case 'upperArm': return 'ä¸Šè‡‚';
                default: return 'æœªæ ‡è®°éƒ¨ä½';
            }
        }

        function bindSetupEvents() {
            const form = document.getElementById('setupForm');
            if (!form) return;
            form.addEventListener('submit', event => {
                event.preventDefault();
                const data = new FormData(form);
                const last = data.get('last');
                const record = {
                    initialized: true,
                    currentDose: data.get('dose'),
                    injectionDay: data.get('weekday'),
                    startDate: last,
                    lastInjection: last,
                    nextInjection: nextWeek(last),
                    reminders: {
                        browser: data.get('notify') === 'yes',
                        email: false
                    }
                };
                App.update(state => Object.assign(state, record));
                if (record.reminders.browser) {
                    ensureNotificationPermission();
                }
            }, { once: true });
        }

        function bindDashboardEvents() {
            const toggleRecord = document.getElementById('toggleRecord');
            const recordForm = document.getElementById('recordForm');
            const reminderForm = document.getElementById('reminderForm');
            const toggleContact = document.getElementById('toggleContact');
            const contactForm = document.getElementById('contactForm');
            const exportButton = document.getElementById('exportButton');
            const copySummary = document.getElementById('copySummary');
            const toggleTestForm = document.getElementById('toggleTestForm');
            const toggleReviewForm = document.getElementById('toggleReviewForm');
            const testForm = document.getElementById('testForm');
            const reviewForm = document.getElementById('reviewForm');

            if (toggleRecord && recordForm) {
                toggleRecord.addEventListener('click', () => {
                    recordForm.classList.toggle('hidden');
                });
            }

            if (recordForm) {
                recordForm.addEventListener('submit', event => {
                    event.preventDefault();
                    const data = new FormData(recordForm);
                    const date = data.get('date');
                    const site = data.get('site');
                    if (!date || !site) return;
                    const note = data.get('note');
                    const entry = {
                        date,
                        site,
                        note,
                        recordedAt: new Date().toISOString()
                    };
                    App.update(state => {
                        if (!state.startDate) {
                            state.startDate = date;
                        }
                        state.lastInjection = date;
                        state.nextInjection = nextWeek(date);
                        state.injectionHistory.push(entry);
                        state.injectionSites[site] = [...(state.injectionSites[site] || []), date];
                    });
                    setTimeout(() => {
                        const formEl = document.getElementById('recordForm');
                        if (formEl) {
                            formEl.reset();
                            const dateInput = formEl.querySelector('input[name="date"]');
                            if (dateInput) {
                                dateInput.value = new Date().toISOString().slice(0, 10);
                            }
                        }
                    }, 0);
                });
            }

            if (reminderForm) {
                reminderForm.addEventListener('submit', event => {
                    event.preventDefault();
                    const data = new FormData(reminderForm);
                    App.update(state => {
                        state.reminders.browser = !!data.get('browser');
                        state.reminders.email = !!data.get('email');
                    });
                    if (App.state.reminders.browser) {
                        ensureNotificationPermission();
                    }
                });
            }

            if (toggleContact && contactForm) {
                toggleContact.addEventListener('click', () => {
                    contactForm.classList.toggle('hidden');
                });
            }

            if (contactForm) {
                contactForm.addEventListener('submit', event => {
                    event.preventDefault();
                    const data = new FormData(contactForm);
                    const name = data.get('name');
                    const phone = data.get('phone');
                    if (!name || !phone) return;
                    const note = data.get('note');
                    App.update(state => {
                        state.contacts.push({ name, phone, note });
                    });
                    setTimeout(() => {
                        const formEl = document.getElementById('contactForm');
                        if (formEl) {
                            formEl.reset();
                            formEl.classList.add('hidden');
                        }
                    }, 0);
                });
            }

            document.querySelectorAll('.delete-contact').forEach(button => {
                button.addEventListener('click', () => {
                    const index = Number(button.dataset.index);
                    App.update(state => {
                        state.contacts.splice(index, 1);
                    });
                });
            });

            if (toggleTestForm && testForm) {
                toggleTestForm.addEventListener('click', () => {
                    testForm.classList.toggle('hidden');
                });
            }

            if (toggleReviewForm && reviewForm) {
                toggleReviewForm.addEventListener('click', () => {
                    reviewForm.classList.toggle('hidden');
                });
            }

            if (testForm) {
                testForm.addEventListener('submit', event => {
                    event.preventDefault();
                    const data = new FormData(testForm);
                    const name = data.get('name');
                    const date = data.get('date');
                    const result = data.get('result');
                    if (!name || !date || !result) return;
                    const note = data.get('note');
                    App.update(state => {
                        if (!state.quality) {
                            state.quality = { tests: [], reviews: [] };
                        }
                        state.quality.tests.push({ name, date, result, note });
                    });
                    setTimeout(() => {
                        const formEl = document.getElementById('testForm');
                        if (formEl) {
                            formEl.reset();
                            formEl.classList.add('hidden');
                            const dateInput = formEl.querySelector('input[name="date"]');
                            if (dateInput) {
                                dateInput.value = new Date().toISOString().slice(0, 10);
                            }
                        }
                    }, 0);
                });
            }

            if (reviewForm) {
                reviewForm.addEventListener('submit', event => {
                    event.preventDefault();
                    const data = new FormData(reviewForm);
                    const reviewer = data.get('reviewer');
                    const date = data.get('date');
                    const status = data.get('status');
                    if (!reviewer || !date || !status) return;
                    const note = data.get('note');
                    App.update(state => {
                        if (!state.quality) {
                            state.quality = { tests: [], reviews: [] };
                        }
                        state.quality.reviews.push({ reviewer, date, status, note });
                    });
                    setTimeout(() => {
                        const formEl = document.getElementById('reviewForm');
                        if (formEl) {
                            formEl.reset();
                            formEl.classList.add('hidden');
                            const dateInput = formEl.querySelector('input[name="date"]');
                            if (dateInput) {
                                dateInput.value = new Date().toISOString().slice(0, 10);
                            }
                        }
                    }, 0);
                });
            }

            document.querySelectorAll('.delete-test').forEach(button => {
                button.addEventListener('click', () => {
                    const index = Number(button.dataset.index);
                    App.update(state => {
                        if (!state.quality) return;
                        state.quality.tests.splice(index, 1);
                    });
                });
            });

            document.querySelectorAll('.delete-review').forEach(button => {
                button.addEventListener('click', () => {
                    const index = Number(button.dataset.index);
                    App.update(state => {
                        if (!state.quality) return;
                        state.quality.reviews.splice(index, 1);
                    });
                });
            });

            if (exportButton) {
                exportButton.addEventListener('click', () => {
                    const dataStr = JSON.stringify(App.state, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `tirzepatide-data-${Date.now()}.json`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                });
            }

            if (copySummary) {
                copySummary.addEventListener('click', async () => {
                    const recent = App.state.injectionHistory.slice(-4);
                    if (recent.length === 0) {
                        alert('æš‚æ— å¯å¤åˆ¶çš„æ³¨å°„è®°å½•');
                        return;
                    }
                    const summary = recent.map(item => `${formatDate(item.date)} Â· ${siteName(item.site)}${item.note ? `ï¼ˆ${item.note}ï¼‰` : ''}`).join('\n');
                    try {
                        await navigator.clipboard.writeText(summary);
                        alert('æœ€è¿‘ 4 æ¬¡æ³¨å°„è®°å½•å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
                    } catch (err) {
                        console.error(err);
                        alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶');
                    }
                });
            }
        }

        function evaluateReminders() {
            if (!App.state.reminders.browser || !App.state.nextInjection) return;
            ensureNotificationPermission();
            const next = new Date(App.state.nextInjection);
            if (Number.isNaN(next.getTime())) return;
            const now = new Date();
            const hours = (next - now) / (1000 * 60 * 60);
            if (hours <= 24 && hours > 23) {
                sendNotification('æ³¨å°„æé†’', 'è·ç¦»ä¸‹ä¸€æ¬¡ Tirzepatide æ³¨å°„è¿˜æœ‰ 24 å°æ—¶');
            }
            if (hours <= 1 && hours > 0) {
                sendNotification('æ³¨å°„æé†’', 'è¯¥è¿›è¡Œ Tirzepatide æ³¨å°„å•¦ï¼');
            }
        }

        document.getElementById('resetButton').addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå…¨éƒ¨æ•°æ®å—ï¼Ÿè¯¥æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                App.reset();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            render();
            setInterval(evaluateReminders, 60 * 60 * 1000);
        });
    </script>
</body>
</html>
